# Requirements

## Business Requirements

### Purpose
Export ASCOM device telemetry as Prometheus metrics for monitoring observatory equipment.

### Goals
- Know which devices are connected vs disconnected
- Access device telemetry (temperature, position, status, etc.)
- Distinguish between "never connected" and "disconnected" states

## Functional Requirements

### Collection Cycle

#### Refresh Rate
- System must collect metrics on a periodic cycle
- Cycle interval (refresh rate) must be configurable
- Example: 5 second refresh rate = metrics collected every 5 seconds

#### Metric Exposure
- Metrics must be exposed over HTTP
- HTTP port must be configurable
- Metrics must be available at `/metrics` endpoint

### Device Monitoring Modes

#### Permissive Mode
- Monitor devices found via automatic discovery (checked every cycle)
- Devices that never connect: ignored (no metrics)
- Cannot specify which devices to monitor

#### Strict Mode  
- Monitor specific devices by explicit specification (checked every cycle)
- All specified devices treated as disconnected until they connect
- Devices that never connect: same as disconnected (create disconnected metrics, log message)

### Connection Status

#### Connectivity Check
- Device connectivity determined by querying 'name' attribute each cycle
- 'name' attribute exists on all device types

#### States
- Never Connected: Device exists but hasn't responded successfully yet
- Connected: Device currently responding
- Disconnected: Device no longer responding or has never connected if in Strict Mode

#### Logging
- When device first connects: Log "CONNECTED"
- When connected device disconnects: Log "DISCONNECTED"  
- When device stays in same state: No log
- Permissive mode: Log "DISCOVERED" when device found (at startup or when new device appears during runtime)
- Strict mode on startup: Log "CONNECTED" if device responds, "DISCONNECTED" if device doesn't respond

### Metrics

#### Connection Status Metric
- `alpaca_device_connected`: 1 when connected, 0 when disconnected
- Permissive mode: Create only when device first connects
- Strict mode: Create immediately for all specified devices

#### Device Attribute Metrics
- Device-specific attributes (name, temperature, position, etc.)
- Only created when attribute has a valid value
- Updated every cycle while device connected
- Frozen at last value when device disconnected
- When attribute returns "not implemented" (ErrorNumber 1024): Don't create metric, skip attribute in future cycles
- When attribute returns other errors: Retry next cycle, increment error counter
- Special case: When 'name' attribute query fails, device transitions to disconnected state
- When device transitions to connected state: Retry previously skipped attributes (driver may have changed)

#### API Call Counters
- `alpaca_success_total`: Count of successful API calls per device
- `alpaca_success_created`: Timestamp when success counter was created
- `alpaca_error_total`: Count of failed API calls per device
- `alpaca_error_created`: Timestamp when error counter was created
- Permissive mode: Create and increment "success" metrics only after first successful connection
- Strict mode: Create and increment "success" or "error" from first query attempt (success if connected, error if disconnected)
- "Not implemented" responses (ErrorNumber 1024) don't increment counters

#### Metric Labels
- All device metrics must include: `device_type`, `device_number`
- Additional labels may be configured per device type

### Configuration

#### Attribute Selection
- Attributes to monitor are defined in configuration files
- One configuration file per device type (camera, telescope, rotator, etc.)
- Files are part of the codebase (not per-deployment customization)
- If device type discovered/specified without corresponding configuration file: System must terminate with error

#### Metric Naming
- Use Prometheus naming conventions (snake_case)
- Allow translation from ASCOM attribute names to custom metric names

### Alpaca Server Availability

#### Startup Behavior
- If Alpaca server unreachable at startup: Retry in loop, do not create metrics
- System waits indefinitely for server to become available

#### Runtime Behavior
- If Alpaca server becomes unreachable during runtime: All devices transition to disconnected state
- System continues running and retrying

## Constraints

### API Limitations
- Cannot discover which attributes exist on a device
- Must query each attribute individually

## Non-Goals

- Device control
- Data storage
- Alerting

---

**Generated By:** Cursor (Claude Sonnet 4.5)
