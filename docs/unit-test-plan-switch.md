# Unit Test Plan: Switch Device Behavior

**Generated By:** Cursor (Claude Sonnet 4.5)

## Overview

Switch devices in ASCOM Alpaca are unique - they represent a collection of individual switches, each identified by an `id` parameter. This requires special handling in the exporter.

## Switch-Specific Behavior

From `src/exporter_core.py`:
```python
# SWITCH is a special device with an "id" query param
if device_type == "switch":
    ids = get_value_cached_fn(alpaca_base_url, device_type, device_number, "maxswitch")
    for id in range(ids):
        # Create a copy of labels for each switch ID
        switch_labels = labels.copy()
        switch_labels["id"] = id
        querystr = f"id={id}"
        
        # Device specific labels for this switch ID
        # Collect metrics for this switch ID
```

Key differences:
1. Must query `maxswitch` to get number of switches
2. Iterates over each switch ID (0-based)
3. Each switch ID gets its own label set
4. Query string includes `id={id}` parameter

---

## Test Cases

### 1. Switch Device with Multiple Switches

**Scenario:** Switch device reports `maxswitch=4` (4 individual switches)

**Setup:**
- Mock `getValueCached()` for `maxswitch` to return 4
- Mock switch-specific attributes for id=0,1,2,3
- Configuration has labels and metrics for switches

**Expected Behavior:**
- Queries `maxswitch` once (should be cached)
- Creates metrics for each switch ID (0, 1, 2, 3)
- Each metric has unique `id` label
- Query string includes `id={id}` for each

**Verification:**
```python
# Should see 4 sets of metrics, one per switch
assert len(collected_metrics) == 4 * num_metrics_per_switch
# Each should have different id label
assert {m[1]['id'] for m in collected_metrics if 'id' in m[1]} == {0, 1, 2, 3}
```

---

### 2. Switch Device with Single Switch

**Scenario:** Switch device with only one switch (maxswitch=1)

**Setup:**
- Mock `getValueCached()` for `maxswitch` to return 1
- Mock switch attributes for id=0

**Expected Behavior:**
- Still iterates over range(1) = [0]
- Creates metrics for id=0
- Metrics have `id=0` label

---

### 3. Switch ID Labels Are Independent

**Scenario:** Each switch ID should have independent label sets

**Setup:**
- Switch device with `maxswitch=3`
- Configuration requests switch-specific labels (e.g., switch name, description)
- Each switch ID has different label values

**Expected Behavior:**
- Labels queried with `id=0`, `id=1`, `id=2` query strings
- Each switch gets its own label set
- Label values can differ per switch ID

**Example:**
```python
# Switch 0: name="Lights", description="Dome Lights"
# Switch 1: name="Fan", description="Cooling Fan"
# Switch 2: name="Heater", description="Mirror Heater"
```

---

### 4. Switch Metrics Use ID Query Parameter

**Scenario:** Metric collection includes `id` in query string

**Setup:**
- Switch device with `maxswitch=2`
- Configuration requests metrics like `getswitch`, `getswitchvalue`

**Expected Behavior:**
- Each metric queried with `id={id}` parameter
- `getValue()` or `getValueCached()` called with `querystr=f"id={id}"`

**Verification:**
```python
# Verify query strings
mock_get_value.assert_any_call(url, "switch", 0, "getswitch", "id=0", ...)
mock_get_value.assert_any_call(url, "switch", 0, "getswitch", "id=1", ...)
```

---

### 5. Switch maxswitch is Cached

**Scenario:** `maxswitch` should be cached, not queried every iteration

**Setup:**
- Switch device with `maxswitch=5`
- Main loop runs multiple iterations

**Expected Behavior:**
- `maxswitch` queried once via `getValueCached()`
- Subsequent iterations use cached value
- Not queried per-switch-ID

**Verification:**
```python
# After multiple iterations
assert mock_get_value_cached.call_count == 1  # Only called once for maxswitch
```

---

### 6. Switch with Zero Switches

**Scenario:** Edge case - `maxswitch=0` (no switches)

**Setup:**
- Switch device reports `maxswitch=0`

**Expected Behavior:**
- `range(0)` produces empty sequence
- No switch-specific metrics created
- Device still tracked as connected
- No errors or crashes

---

### 7. Non-Switch Devices Don't Get ID Label

**Scenario:** Other device types should not have `id` label

**Setup:**
- Telescope, camera, focuser devices (non-switch)
- Configuration requests metrics

**Expected Behavior:**
- Metrics do NOT have `id` label
- Query strings do NOT include `id=` parameter
- No iteration over IDs

**Verification:**
```python
# Verify no id label
for metric in collected_metrics:
    assert 'id' not in metric[1]  # labels dict
```

---

### 8. Switch State Transitions with Multiple IDs

**Scenario:** Switch reconnects - all IDs should be processed

**Setup:**
- Switch with `maxswitch=3`
- Device disconnects then reconnects

**Expected Behavior:**
- On reconnect: skip list reset (per device, not per ID)
- All 3 switch IDs processed again
- Each ID gets fresh metrics

---

### 9. Switch Skip List Behavior

**Scenario:** If a switch attribute returns error 1024, it's added to skip list

**Setup:**
- Switch with `maxswitch=2`
- Attribute `getswitchvalue` returns error 1024 for all IDs

**Expected Behavior:**
- Skip list applies to device, not specific ID
- After first error, attribute skipped for all IDs
- Skip list key: `switch/0` (device-level, not `switch/0/id=0`)

---

### 10. Switch Label Copying

**Scenario:** Base labels should be copied, not mutated

**Setup:**
- Switch with `maxswitch=2`
- Base labels: `{device_type, device_number, name}`

**Expected Behavior:**
- Each switch ID gets a **copy** of base labels
- Adding `id` label doesn't affect other IDs
- Base labels remain unchanged

**Verification:**
```python
# Verify label independence
id0_labels = metrics_for_id0[0][1]
id1_labels = metrics_for_id1[0][1]
assert id0_labels['id'] == 0
assert id1_labels['id'] == 1
# Modifying one doesn't affect the other
assert id0_labels is not id1_labels
```

---

## Implementation Notes

### Test File Location
`tests/unit/test_switch_device.py`

### Mock Strategy
- Mock `getValueCached()` for `maxswitch`
- Mock `getValue()` / `getValueCached()` for switch attributes
- Verify query strings include `id={id}`
- Verify labels include `id` key

### Configuration
Use minimal switch configuration:
```python
configurations = {
    "switch": {
        "metric_prefix": "alpaca_switch_",
        "labels": [
            {"alpaca_name": "getswitchname", "label_name": "switch_name"}
        ],
        "metrics": [
            {"alpaca_name": "getswitch", "metric_name": "state"},
            {"alpaca_name": "getswitchvalue", "metric_name": "value"}
        ]
    }
}
```

---

## Summary

Switch devices require special handling due to their multi-switch nature. Tests must verify:

1. ✅ Iteration over multiple switch IDs
2. ✅ Unique labels per ID
3. ✅ Query strings include `id` parameter
4. ✅ Label copying (not mutation)
5. ✅ Cached `maxswitch` query
6. ✅ Edge cases (zero switches, single switch)
7. ✅ Skip list applies device-wide
8. ✅ Non-switch devices unaffected

These tests ensure switch devices work correctly without breaking other device types.

